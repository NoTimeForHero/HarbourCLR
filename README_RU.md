# Harbour CLR Interop - Alpha
[English README](README.md)

Библиотека, которая позволяет вызывать любые CLR (.NET) сборки из языка программирования Harbour.
На текущей стадии разработки этой библиотеки, вам возможно понадобится использовать дополнительный код на CLR, чтобы избегать утечек памяти и неожиданных приведений типов.

Установленные версии .NET Framework на вашей машине вы можете найти внутри директории %WINDIR%\Microsoft.NET\Framework

## Как использовать
1. Добавьте ссылку на CLR библиотеку в ваш HBP файл (-oclr)
2. Положите скомпилированную динамическую библиотеку (clrdyn.dll) в выходную директорию, в которую собирается проект.
3. Добавьте в эту же директорию необходимые вам для работы CLR сборки.
4. Загрузите исполняемую среду CLR при помощи создания экземпляра класса CLR_RUNTIME():New("v4.0.30319")
5. Вызовите CLR_RUNTIME:LoadAssembly(ASSEMBLY_NAME) для того, чтобы загрузить необходимую вам CLR сборку (оно вернет новый экземпляр класса CLR_ASSEMBLY)
6. Теперь вы можете вызывать статические методы при помощи CLR_ASSEMBLY->CallStatic(TYPE_NAME, ...ARGS...), возвращающие любые поддерживаемые библотекой значения
7. Для того, чтобы создать экземпляр CLR объекта (CLR_OBJECT) вызовете CLR_ASSEMBLY->CreateInstance(TYPE_NAME, ...ARGS..)
8. Чтобы вызывать методы созданного объекта используйте CLR_OBJECT->CALL(...ARGS...), возвращающие любые поддерживаемые библотекой значения

Для дополнительной информации вы можете посмотреть [пример](example/demo_oop.prg)

## Конвертация типов
### Поддерживаемые типы:
* NIL
* Array
* Logical
* Integer
* Long
* Double
* String

### НЕподдерживаемые типы:
* Date
* Timestamp
* Alias
* Symbol
* Pointer

**Внимание!** Следующие C# типы содержат неожиданные приведения из-за особенностей Harbour: 
* (unsigned) byte → HB_LONG
* (unsigned) short → HB_LONG
* (unsigned) int → HB_LONG 
* unsigned long → HB_LONG
* float → HB_DOUBLE
* object/unknown → HB_NIL


## Планы на будущее
* Написать нормальный README.md
* Возвращать CLR объекты из методов __CLR_CALL_STATIC/__CLR_CALL, а не только примитивные типы
* Реализовать сборку мусора (при помощи hb_retptrGC?)
* Проверить, нормально ли очищать память сообщения HB_errInternal const char * сразу после выброса ошибки
* Отображать нормальные сообщения об ошибках (переписать NetException для поддержки стека вызовов CLR?)
* Callbacks то есть вызов Harbour функций из CLR сборок (возможно потребуется дополнительная библиотека для нормального синтаксиса?)
* Больше адекватных примеров

### Завершено
* Статическая библиотека для поддержки CLR вызовов (с функциями Harbour вроде __CLR_INIT)
* Реализация на классах вместо некрасивых *__CLR_xxxx(\*ptr, ...)* методов
* Юнит-тестирование